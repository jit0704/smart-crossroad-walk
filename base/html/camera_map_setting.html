<!DOCTYPE html>
<html lang="ko">
  <head>
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <title>지도 - 카메라 Map 설정</title>
    <script src="/base/js/lib/jquery-3.5.1.min.js"></script>
    <script src="/base/js/lib/jquery-ui.min.js"></script>
    <script src="/base/js/lib/semantic.min.js"></script>
    <script src="/base/js/lib/jquery.modal.min.js"></script>
    <script src="https://cdn.polyfill.io/v2/polyfill.min.js?features=requestAnimationFrame,Element.prototype.classList,URL"></script>
    <script src="http://map.ngii.go.kr/emap/js/map/OpenLayers-6.4.3.js"></script>
    <script src="http://map.ngii.go.kr/nps/common/lib/proj4js/proj4.js"></script>
    <script src="http://map.ngii.go.kr/openapi/wmts_ngiiMap_v6.4.3.js?apikey=04trYP9_xwLAfALjwZ-B8g"></script>
    <!-- includeHTML.js : 퍼블리싱 확인용 include -->
    <script src="/base/js/common/includeHTML.js"></script>
    <script src="/base/js/common/ui.js"></script>
    <link rel="stylesheet" href="http://map.ngii.go.kr/emap/css/map/OpenLayers-6.4.3.css" />
    <link rel="stylesheet" href="/base/css/common.css" />
  </head>
  <body>
    <div class="wrapper">
      <!-- GNB -->
      <nav class="gnb" include-html="/base/html/common/gnb.html"></nav>

      <main class="ly-container">
        <div id="map1" class="ly-map camera-map">
          <!-- 화면 위치 -->
          <div class="ui breadcrumb">
            <i class="home icon"></i>
            <i class="right angle icon divider"></i>
            <span class="section">교차로</span>
            <i class="right angle icon divider"></i>
            <div class="section">시스템 관리</div>
            <i class="right angle icon divider"></i>
            <div class="active section">카메라 관리</div>
            <i class="right angle icon divider"></i>
            <div class="section">지점 Map 설정</div>
          </div>

          <!-- 지도 타입 선택 -->
          <div class="map-type">
            <label>
              <input type="radio" checked name="maptype" />
              <span>일반지도</span>
            </label>
            <label>
              <input type="radio" name="maptype" />
              <span>위성지도</span>
            </label>
          </div>
          <!-- //지도 타입 선택 -->

          <!-- 시스템 네비게이션 -->
          <div class="system-nav">
            <button type="button" class="ico-hand"><span class="screen-out">손모양 아이콘</span></button>
            <button type="button" class="ico-set-camera"><span class="screen-out">지점 아이콘</span></button>
          </div>

          <i class="speech-bubble-guide2"><span class="screen-out">카메라를 추가하고 싶은 곳에 마커를 놓아주세요</span></i>

          <!-- 카메라 추가시 노출되는 메뉴 팝업 -->
          <div class="menu-popup js-add-branch">
            <a href="#">카메라 정보 설정</a>
            <a href="#">십자선 보기</a>
            <a href="#" class="js-calcel">취소</a>
          </div>
          <!-- //menu-popup -->

          <!-- 기 등록된 카메라 아이콘 클릭시 노출되는 메뉴 팝업 -->
          <div class="menu-popup js-existing-branch">
            <a href="#" class="js-move-position">카메라 위치 이동</a>
            <a href="#">카메라 정보 조회</a>
            <a href="#">카메라 ROI 설정 </a>
            <a href="#">십자선 보기</a>
            <a href="#">카메라 삭제</a>
          </div>
          <!-- //menu-popup -->

          <!-- 카메라 위치 이동 후 노출되는 메뉴 팝업 -->
          <div class="menu-popup js-move-end">
            <a href="#" class="js-complete">위치 이동 완료</a>
            <a href="#" class="js-calcel">위치 이동 취소</a>
          </div>
          <!-- //menu-popup -->

          <i class="ico-map-above-camera left js-no-dimed-popup-call" data-target="crosswalk-popup" style="left: 717px; top: 555px">
            <span class="screen-out">좌측 카메라</span>
          </i>

          <i class="ico-map-above-camera top js-no-dimed-popup-call" data-target="crosswalk-popup" style="left: 818px; top: 440px">
            <span class="screen-out">상단 카메라</span>
          </i>

          <i class="ico-map-above-camera right js-no-dimed-popup-call" data-target="crosswalk-popup" style="left: 954px; top: 543px">
            <span class="screen-out">우측 카메라</span>
          </i>

          <i class="ico-map-above-camera bottom js-no-dimed-popup-call" data-target="crosswalk-popup" style="left: 820px; top: 700px">
            <span class="screen-out">하단 카메라</span>
          </i>
        </div>
        <!-- //ly-map -->
      </main>
      <!-- //ly-container -->

      <footer class="ly-copyright" include-html="/base/html/common/footer.html"></footer>
    </div>
    <!-- //wrapper -->

    <script>
      // map init
      window.onload = function () {
        var map1 = new ngii_wmts.map('map1', { zoom: 6 });
      };

      // map설정 함수
      function cameraMapSetting() {
        // 지도 화면 우측 중간에 있는 system-nav에서 클릭된 아이콘 상태를 ly-map div태그에 class명으로 추가해주는 함수.
        function systemNavState($this, activeState, lymapAddClass) {
          if ($this.is(activeState)) {
            $('.ly-map').addClass(lymapAddClass);
          } else {
            $('.ly-map').removeClass(lymapAddClass);
            $('.speech-bubble-guide').hide();
          }
        }

        // 우축 중간 시스템 네비게이션 클릭 이벤트
        $('.system-nav [class*="ico"]').on('click', function () {
          var $this = $(this);
          $this.toggleClass('active');
          $('.system-nav button').not(this).removeClass('active');

          systemNavState($this, '.ico-hand.active', 'ico-hand-active');
          systemNavState($this, '.ico-set-camera.active', 'ico-set-camera-active');
          // 지점 추가 메뉴 팝업 숨김
          $('.js-add-branch').fadeOut(200);
        });

        // 마우스 커서가 교차로 아이콘으로 바뀌었을때 커서 위에 안내 말풍선 노출
        var $speechBubbleCam = $('.speech-bubble-guide2');
        $(document).on('mousemove', '.ly-map.ico-set-camera-active', function (e) {
          var x = e.clientX - $(this).offset().left;
          var y = e.clientY - $(this).offset().top;
          $speechBubbleCam.css({
            left: x - 10,
            top: y - 75,
          });
        });

        // 특정 요소에 마우스가 올라갔을때 말풍선 숨김
        var targetParent = '.ly-map.ico-set-camera-active';
        var targetTag = `${targetParent} .ui.dropdown.area-box, ${targetParent} .map-type, ${targetParent} .system-nav, ${targetParent} .menu-popup`;
        $(document).on('mouseenter', targetTag, function () {
          $speechBubbleCam.hide();
        });
        $(document).on('mouseleave', targetTag, function () {
          $speechBubbleCam.show();
        });

        // 마우스 커서가 카메라 아이콘으로 바뀌었을때 지도 위 클릭 이벤트: 메뉴 팝업 생성
        // (국토지리정보원 API 호출시 지도 최상단 부모 클래스명이 ol-viewport로 나옵니다. 개발환경에서도 동일하게 나오는지 확인이 필요하고, 만약 클래스명이 다르면 ol-viewport클래스명 수정이 필요합니다. 참고 바랍니다.)
        $(document).on('click', '.ico-set-camera-active .ol-viewport', function (e) {
          var x = e.clientX + 20;
          var y = e.clientY + 20;
          $('.js-add-branch').fadeIn(200).css({
            left: x,
            top: y,
          });
        });

        // 메뉴 팝업의 취소 버튼 눌렀을때 메뉴 팝업 숨김
        $('.js-add-branch .js-calcel').on('click', function (e) {
          e.preventDefault();
          $(this).parent().fadeOut(200);
        });

        // 기 등록된 카메라 아이콘 클릭 이벤트: 메뉴 팝업 노출
        var $iconCameraPosInit; // 기 등록된(최초의) 카메라 아이콘의 좌표값을 저장하는 변수
        $('.ico-map-above-camera').on('click', function (e) {
          // 기 등록된(최초의) 카메라 아이콘의 좌표값을 전역변수($iconCameraPosInit)에 저장
          // 카메라 위치 이동 후 '취소' 할 경우 최초의 좌표값 정보가 필요하기 때문.
          if (!$(this).is('.moving')) {
            $iconCameraPosInit = $(this).css(['left', 'top']);
          }
          // ico-map-above-camera 요소에 data속성 추가
          $('.ico-map-above-camera').each(function (idx, el) {
            $(el).attr('data-name', `ico-map-above-camera${idx + 1}`);
          });
          var x = e.clientX + 20;
          var y = e.clientY + 20;
          var $dataName = $(this).data('name');
          if (!$(this).is('.moving')) {
            $('.js-existing-branch').attr('data-name', $dataName).fadeIn(200).css({
              left: x,
              top: y,
            });
          }
        });

        // 지도 위 아무곳이나 클릭하면 기 등록된 지점 메뉴 팝업 숨김
        // (국토지리정보원 API 호출시 지도 최상단 부모 클래스명이 ol-viewport로 나옵니다. 개발환경에서도 동일하게 나오는지 확인이 필요하고, 만약 클래스명이 다르면 ol-viewport클래스명 수정이 필요합니다. 참고 바랍니다.)
        $(document).on('click', '.ol-viewport', function () {
          $('.js-existing-branch').fadeOut(200);
        });

        // '지점 위치 이동' 메뉴 클릭시 교차로 아이콘 드래그 가능하도록 설정
        $('.js-existing-branch .js-move-position').on('click', function (e) {
          e.preventDefault();
          var menuData = $(this).parent().attr('data-name');
          var iconCamera = $(`.ico-map-above-camera[data-name="${menuData}"]`);
          $(this).parent().fadeOut(200);
          iconCamera.addClass('moving');
          if (iconCamera.is('.moving')) {
            iconCamera.draggable({
              containment: '.ly-map',
              drag: function () {
                $('.js-move-end').attr('data-name', menuData).fadeOut(200);
              },
              stop: function (e, ui) {
                // 드래그가 끝날 때 좌표를 저장.
                var endX = e.clientX + 20;
                var endY = e.clientY + 20;
                $('.js-move-end').fadeIn(200).css({
                  left: endX,
                  top: endY,
                });
              },
            });
          }
        });

        // '위치 이동 완료' 버튼 클릭시 카메라 아이콘 이동
        $('.js-move-end .js-complete').on('click', function (e) {
          e.preventDefault();
          var menuData = $(this).parent().attr('data-name');
          var x = parseInt($(this).parent().css('left')) - 130;
          var y = parseInt($(this).parent().css('top')) - 50;
          $(this).parent().fadeOut(200);

          // 카메라 아이콘 위치를 이동
          var $iconCamera = $(`.ico-map-above-camera[data-name="${menuData}"]`);
          var $iconCameraPos = $iconCamera.css(['left', 'top']);
          $iconCamera.draggable('destroy').removeClass('moving').css($iconCameraPos);
        });

        // '위치 이동 취소' 버튼 클릭시 카메라 아이콘 원복 설정
        $('.js-move-end .js-calcel').on('click', function (e) {
          e.preventDefault();
          var menuData = $(this).parent().attr('data-name');
          $(this).parent().fadeOut(200);
          // 카메라 아이콘 위치를 원복함
          $(`.ico-map-above-camera[data-name="${menuData}"]`).draggable('destroy').removeClass('moving').css($iconCameraPosInit);
        });
      }
      cameraMapSetting();
    </script>
  </body>
</html>
